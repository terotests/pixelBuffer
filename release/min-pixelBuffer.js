var pixelBuffer_prototype=function(){"use strict";!function(t){var r,a,i,e;t._createTables=function(){i=function(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},a=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],e=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]},t._stackBlurRGB=function(t,r,n,f){if(!(isNaN(f)||1>f)){f|=0;var o,s,u,l,h,c,p,v,_,x,g,b,d,w,I,B,m,y,M,C,R=t.data,k=f+f+1,A=r-1,E=n-1,G=f+1,N=G*(G+1)/2,D=new i,F=D;for(u=1;k>u;u++)if(F=F.next=new i,u==G)var O=F;F.next=D;var j=null,P=null;p=c=0;var T=a[f],H=e[f];for(s=0;n>s;s++){for(w=I=B=v=_=x=0,g=G*(m=R[c]),b=G*(y=R[c+1]),d=G*(M=R[c+2]),v+=N*m,_+=N*y,x+=N*M,F=D,u=0;G>u;u++)F.r=m,F.g=y,F.b=M,F=F.next;for(u=1;G>u;u++)l=c+((u>A?A:u)<<2),v+=(F.r=m=R[l])*(C=G-u),_+=(F.g=y=R[l+1])*C,x+=(F.b=M=R[l+2])*C,w+=m,I+=y,B+=M,F=F.next;for(j=D,P=O,o=0;r>o;o++)R[c]=v*T>>H,R[c+1]=_*T>>H,R[c+2]=x*T>>H,v-=g,_-=b,x-=d,g-=j.r,b-=j.g,d-=j.b,l=p+((l=o+f+1)<A?l:A)<<2,w+=j.r=R[l],I+=j.g=R[l+1],B+=j.b=R[l+2],v+=w,_+=I,x+=B,j=j.next,g+=m=P.r,b+=y=P.g,d+=M=P.b,w-=m,I-=y,B-=M,P=P.next,c+=4;p+=r}for(o=0;r>o;o++){for(I=B=w=_=x=v=0,c=o<<2,g=G*(m=R[c]),b=G*(y=R[c+1]),d=G*(M=R[c+2]),v+=N*m,_+=N*y,x+=N*M,F=D,u=0;G>u;u++)F.r=m,F.g=y,F.b=M,F=F.next;for(h=r,u=1;f>=u;u++)c=h+o<<2,v+=(F.r=m=R[c])*(C=G-u),_+=(F.g=y=R[c+1])*C,x+=(F.b=M=R[c+2])*C,w+=m,I+=y,B+=M,F=F.next,E>u&&(h+=r);for(c=o,j=D,P=O,s=0;n>s;s++)l=c<<2,R[l]=v*T>>H,R[l+1]=_*T>>H,R[l+2]=x*T>>H,v-=g,_-=b,x-=d,g-=j.r,b-=j.g,d-=j.b,l=o+((l=s+G)<E?l:E)*r<<2,v+=w+=j.r=R[l],_+=I+=j.g=R[l+1],x+=B+=j.b=R[l+2],j=j.next,g+=m=P.r,b+=y=P.g,d+=M=P.b,w-=m,I-=y,B-=M,P=P.next,c+=r}}},t._stackBlurRGBA=function(t,r,n,f){if(!(isNaN(f)||1>f)){f|=0;var o,s,u,l,h,c,p,v,_,x,g,b,d,w,I,B,m,y,M,C,R,k,A,E,G=t.data,N=f+f+1,D=r-1,F=n-1,O=f+1,j=O*(O+1)/2,P=new i,T=P;for(u=1;N>u;u++)if(T=T.next=new i,u==O)var H=T;T.next=P;var S=null,W=null;p=c=0;var q=a[f],z=e[f];for(s=0;n>s;s++){for(B=m=y=M=v=_=x=g=0,b=O*(C=G[c]),d=O*(R=G[c+1]),w=O*(k=G[c+2]),I=O*(A=G[c+3]),v+=j*C,_+=j*R,x+=j*k,g+=j*A,T=P,u=0;O>u;u++)T.r=C,T.g=R,T.b=k,T.a=A,T=T.next;for(u=1;O>u;u++)l=c+((u>D?D:u)<<2),v+=(T.r=C=G[l])*(E=O-u),_+=(T.g=R=G[l+1])*E,x+=(T.b=k=G[l+2])*E,g+=(T.a=A=G[l+3])*E,B+=C,m+=R,y+=k,M+=A,T=T.next;for(S=P,W=H,o=0;r>o;o++)G[c+3]=A=g*q>>z,0!=A?(A=255/A,G[c]=(v*q>>z)*A,G[c+1]=(_*q>>z)*A,G[c+2]=(x*q>>z)*A):G[c]=G[c+1]=G[c+2]=0,v-=b,_-=d,x-=w,g-=I,b-=S.r,d-=S.g,w-=S.b,I-=S.a,l=p+((l=o+f+1)<D?l:D)<<2,B+=S.r=G[l],m+=S.g=G[l+1],y+=S.b=G[l+2],M+=S.a=G[l+3],v+=B,_+=m,x+=y,g+=M,S=S.next,b+=C=W.r,d+=R=W.g,w+=k=W.b,I+=A=W.a,B-=C,m-=R,y-=k,M-=A,W=W.next,c+=4;p+=r}for(o=0;r>o;o++){for(m=y=M=B=_=x=g=v=0,c=o<<2,b=O*(C=G[c]),d=O*(R=G[c+1]),w=O*(k=G[c+2]),I=O*(A=G[c+3]),v+=j*C,_+=j*R,x+=j*k,g+=j*A,T=P,u=0;O>u;u++)T.r=C,T.g=R,T.b=k,T.a=A,T=T.next;for(h=r,u=1;f>=u;u++)c=h+o<<2,v+=(T.r=C=G[c])*(E=O-u),_+=(T.g=R=G[c+1])*E,x+=(T.b=k=G[c+2])*E,g+=(T.a=A=G[c+3])*E,B+=C,m+=R,y+=k,M+=A,T=T.next,F>u&&(h+=r);for(c=o,S=P,W=H,s=0;n>s;s++)l=c<<2,G[l+3]=A=g*q>>z,A>0?(A=255/A,G[l]=(v*q>>z)*A,G[l+1]=(_*q>>z)*A,G[l+2]=(x*q>>z)*A):G[l]=G[l+1]=G[l+2]=0,v-=b,_-=d,x-=w,g-=I,b-=S.r,d-=S.g,w-=S.b,I-=S.a,l=o+((l=s+O)<F?l:F)*r<<2,v+=B+=S.r=G[l],_+=m+=S.g=G[l+1],x+=y+=S.b=G[l+2],g+=M+=S.a=G[l+3],S=S.next,b+=C=W.r,d+=R=W.g,w+=k=W.b,I+=A=W.a,B-=C,m-=R,y-=k,M-=A,W=W.next,c+=r}}},t.applyFilters=function(t,r){var a=this;r.forEach(function(r){var i=r[0],e=r[1];a[i]&&a[i](t,e)})},t.bc=function(t,r){this.brightnessContrast(t,r)},t.blur=function(t,r){r.alphablur?this._stackBlurRGBA(t,t.width,t.height,r.blur||3):this._stackBlurRGB(t,t.width,t.height,r.blur||3)},t.brightnessContrast=function(t,r){var a=pixelBuffer.data,i=t.width,e=t.height,n=parseInt(r.brightness,10)||0,f=parseFloat(r.contrast)||0,o=!1;if(o)n=Math.min(150,Math.max(-150,n));else var s=1+Math.min(150,Math.max(-150,n))/150;f=Math.max(0,f+1);var u,l,h,c,p=i*e,v=4*p;1!=f?o?(h=f,c=(n-128)*f+128):(h=s*f,c=128*-f+128):o?(h=1,c=n):(h=s,c=0);for(var _,x,g;p--;)a[v]=(_=a[v-=4]*h+c)>255?255:0>_?0:_,a[u]=(x=a[u=v+1]*h+c)>255?255:0>x?0:x,a[l]=(g=a[l=v+2]*h+c)>255?255:0>g?0:g;return!0},t.createRenderBuffer=function(t,r,a){var i=document.createElement("canvas");i.setAttribute("width",t),i.setAttribute("height",r);var e=i.getContext("2d");return a&&e.drawImage(a,0,0),{canvas:i,buffer:e.getImageData(0,0,t,r)}},t.grayscale=function(t,r){r=r||{};for(var a=r.grayscale||1,i=t.width,e=t.height,n=t.data,f=0,o=i*e*4;o>f;){var s=n[f],u=n[f+1],l=n[f+2],h=Math.floor(.2126*s+.7152*u+.0722*l);s=(1-a)*s+a*h,u=(1-a)*u+a*h,l=(1-a)*l+a*h,n[f]=Math.max(0,Math.min(s,255)),n[f+1]=Math.max(0,Math.min(u,255)),n[f+2]=Math.max(0,Math.min(l,255)),f+=4}},t.hsl=function(t,r,a,i){if(i){var e=t.cData.data,n=parseInt(i.h,10)||0,f=(parseInt(i.s,10)||0)/100,o=(parseInt(i.l,10)||0)/100;if(0>f)var s=1+f;else var s=1+2*f;n=n%360/360;for(var u=6*n,l=255*o,h=1+o,c=1-o,p=r*a,v=4*p,_=v+1,x=v+2;p--;){var g=e[v-=4],b=e[_=v+1],d=e[x=v+2];if(0!=n||0!=f){var w=g;b>w&&(w=b),d>w&&(w=d);var I=g;I>b&&(I=b),I>d&&(I=d);var B=w-I,m=(I+w)/510;if(m>0&&B>0){if(.5>=m){var y=B/(w+I)*s;y>1&&(y=1);var M=m*(1+y)}else{var y=B/(510-w-I)*s;y>1&&(y=1);var M=m+y-m*y}if(g==w)if(b==I)var a=5+(w-d)/B+u;else var a=1-(w-b)/B+u;else if(b==w)if(d==I)var a=1+(w-g)/B+u;else var a=3-(w-d)/B+u;else if(g==I)var a=3+(w-b)/B+u;else var a=5-(w-g)/B+u;0>a&&(a+=6),a>=6&&(a-=6);var C=m+m-M,R=a>>0;0==R?(g=255*M,b=255*(C+(M-C)*(a-R)),d=255*C):1==R?(g=255*(M-(M-C)*(a-R)),b=255*M,d=255*C):2==R?(g=255*C,b=255*M,d=255*(C+(M-C)*(a-R))):3==R?(g=255*C,b=255*(M-(M-C)*(a-R)),d=255*M):4==R?(g=255*(C+(M-C)*(a-R)),b=255*C,d=255*M):5==R&&(g=255*M,b=255*C,d=255*(M-(M-C)*(a-R)))}}0>o?(g*=h,b*=h,d*=h):o>0&&(g=g*c+l,b=b*c+l,d=d*c+l),e[v]=0>g?0:g>255?255:g,e[_]=0>b?0:b>255?255:b,e[x]=0>d?0:d>255?255:d}}},t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){this.filterCanvas=null,this.maxW=0,this.maxH=0,r||(this._createTables(),r=!0)}),t.output=function(t,r){if(r.outputCanvas){var a=r.outputCanvas.getContext("2d");a.putImageData(t,0,0)}},t.sepia=function(t,r){var a=t.width,i=t.height,e=4*a,n=i,f=r.sepia||1;f||(f=1);var o=t.data;do{var s=(n-1)*e,u=a;do{var l,h,c,p=s+4*(u-1),v=o[p],_=o[p+1],x=o[p+2],l=(1-f)*v+f*(.393*v+.769*_+.189*x),h=(1-f)*_+f*(.349*v+.686*_+.168*x),c=(1-f)*x+f*(.272*v+.534*_+.131*x);0>l&&(l=0),l>255&&(l=255),0>h&&(h=0),h>255&&(h=255),0>c&&(c=0),c>255&&(c=255),o[p]=l,o[p+1]=h,o[p+2]=c}while(--u)}while(--n)}}(this),function(t){t.__traitInit&&!t.hasOwnProperty("__traitInit")&&(t.__traitInit=t.__traitInit.slice()),t.__traitInit||(t.__traitInit=[]),t.__traitInit.push(function(){})}(this)},pixelBuffer=function(t,r,a,i,e,n,f,o){if(!(this instanceof pixelBuffer))return new pixelBuffer(t,r,a,i,e,n,f,o);var s=[t,r,a,i,e,n,f,o];if(this.__factoryClass){var u,l=this;if(this.__factoryClass.forEach(function(t){u=t.apply(l,s)}),"[object Function]"==Object.prototype.toString.call(u)){if(u._classInfo.name!=pixelBuffer._classInfo.name)return new u(t,r,a,i,e,n,f,o)}else if(u)return u}if(this.__traitInit){var l=this;this.__traitInit.forEach(function(t){t.apply(l,s)})}else"function"==typeof this.init&&this.init.apply(this,s)};pixelBuffer._classInfo={name:"pixelBuffer"},pixelBuffer.prototype=new pixelBuffer_prototype,"undefined"!=typeof window&&(window.pixelBuffer=pixelBuffer),"undefined"!=typeof window&&(window.pixelBuffer_prototype=pixelBuffer_prototype);